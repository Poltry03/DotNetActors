<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actors Management</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>

<body class="bg-light">

    <!-- ========================= -->
    <!--         LOGIN UI          -->
    <!-- ========================= -->
    <div id="loginContainer" class="container py-5" style="max-width: 400px; display:none;">
        <h3 class="mb-4 text-center fw-bold">Login</h3>

        <div class="card p-4 shadow">
            <div class="mb-3">
                <label class="form-label">Username</label>
                <input id="loginUser" class="form-control" type="text">
            </div>

            <div class="mb-3">
                <label class="form-label">Password</label>
                <input id="loginPass" class="form-control" type="password">
            </div>

            <button class="btn btn-primary w-100" onclick="doLogin()">Accedi</button>

            <p id="loginError" class="text-danger mt-3"></p>
        </div>
    </div>

    <!-- ========================= -->
    <!--     MAIN APPLICATION      -->
    <!-- ========================= -->
    <div id="appContainer" style="display:none;">

        <div class="container py-4">

            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold">Actors</h2>

                <div class="d-flex align-items-center gap-3">
                    <strong id="welcomeUser" class="text-primary"></strong>
                    <button class="btn btn-outline-danger btn-sm" onclick="logout()">Logout</button>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#actorModal" onclick="openAddModal()">
                        + Nuovo Attore
                    </button>
                </div>
            </div>

            <!-- Search -->
            <form id="searchForm" class="input-group mb-4">
                <input type="text" id="searchText" class="form-control" placeholder="Cerca attore per nome…">
                <button class="btn btn-primary" type="submit">Cerca</button>
            </form>

            <!-- Cards -->
            <div id="actorsContainer" class="row g-4">
                <!-- render dinamico -->
            </div>
        </div>

        <!-- MODAL Aggiunta/Modifica -->
        <div class="modal fade" id="actorModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">

                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTitle">Nuovo Attore</h5>
                        <button class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body">
                        <form id="actorForm">
                            <input type="hidden" id="actorId">

                            <div class="mb-3">
                                <label class="form-label">Nome *</label>
                                <input type="text" id="actorNome" class="form-control" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Cognome *</label>
                                <input type="text" id="actorCognome" class="form-control" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Nazionalità *</label>
                                <input type="text" id="actorNazionalita" class="form-control" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Numero film</label>
                                <input id="actorNumeroFilm" class="form-control" type="number" min="0" value="0">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Parcella per film ($)</label>
                                <input id="actorParcellaPerFilm" class="form-control" type="number" min="0" step="0.01" value="0">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">URL Immagine *</label>
                                <input type="text" id="actorImmagineUrl" class="form-control" required>
                            </div>
                        </form>
                    </div>

                    <div class="modal-footer">
                        <button class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                        <button class="btn btn-primary" onclick="saveActor()">Salva</button>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>


    <!-- ========================= -->
    <!--         APP LOGIC         -->
    <!-- ========================= -->
    <script>

        let jwtToken = null;
        let loggedUserName = null;

        const apiBase = "/Actor";

        // ------------------------------
        //   VISUAL LOGIC
        // ------------------------------
        function showLogin() {
            $("#loginContainer").show();
            $("#appContainer").hide();
        }

        function showApp() {
            $("#loginContainer").hide();
            $("#appContainer").show();
            $("#welcomeUser").text(`Ciao ${loggedUserName}`);
        }

        // ------------------------------
        //   DO LOGIN
        // ------------------------------
        function doLogin() {
            const username = $("#loginUser").val();
            const password = $("#loginPass").val();

            $.ajax({
                url: "/api/login",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({ username, password }),

                success: function (res) {
                    jwtToken = res.token;
                    loggedUserName = res.name;

                    localStorage.setItem("jwtToken", jwtToken);
                    localStorage.setItem("loggedUserName", loggedUserName);

                    showApp();
                    loadActors();
                },

                error: function () {
                    $("#loginError").text("Credenziali non valide");
                }
            });
        }

        // ------------------------------
        //   LOGOUT
        // ------------------------------
        function logout() {
            jwtToken = null;
            loggedUserName = null;

            localStorage.removeItem("jwtToken");
            localStorage.removeItem("loggedUserName");

            showLogin();
        }

        // ------------------------------
        //   AUTH HEADER
        // ------------------------------
        function authHeaders() {
            return { Authorization: "Bearer " + jwtToken };
        }

        // ------------------------------
        //   LOAD ACTORS
        // ------------------------------
        function loadActors(search = "") {
            // CORRETTO: il backend usa "research" come nome del parametro
            const url = search ? `${apiBase}/research?research=${encodeURIComponent(search)}` : apiBase;

            console.log("🔍 Caricamento attori da URL:", url);
            console.log("🔑 Token JWT:", jwtToken ? "presente" : "MANCANTE");

            $.ajax({
                url: url,
                method: "GET",
                headers: authHeaders(),
                success: function (data) {
                    console.log("✅ Risposta ricevuta:", data);
                    console.log("📊 Tipo di dato:", typeof data);
                    console.log("📏 Lunghezza array:", Array.isArray(data) ? data.length : "Non è un array");
                    renderActors(data);
                },
                error: function (err) {
                    console.error("❌ Errore caricamento attori:", err);
                    console.error("Status:", err.status);
                    console.error("Response:", err.responseText);
                    $("#actorsContainer").html(`<p class="text-center text-danger">Errore nel caricamento degli attori (${err.status})</p>`);
                }
            });
        }

        // ------------------------------
        //   RENDER
        // ------------------------------
        function renderActors(actors) {
            console.log("🎨 Inizio rendering con dati:", actors);

            const container = $("#actorsContainer");
            container.empty();

            if (!actors || !actors.length) {
                console.warn("⚠️ Nessun attore da visualizzare");
                container.html(`<p class="text-center text-muted">Nessun attore trovato.</p>`);
                return;
            }

            console.log(`✨ Rendering di ${actors.length} attori`);

            actors.forEach((actor, index) => {
                console.log(`Attore ${index}:`, actor);

                // CORRETTO: Il backend restituisce camelCase (minuscolo)
                const imgUrl = actor.imgUrl || 'https://via.placeholder.com/300x200?text=No+Image';
                const name = actor.name || '';
                const surname = actor.surname || '';
                const nation = actor.nation || 'Non specificata';
                const filmQty = actor.filmQuantity || 0;
                const cachet = actor.filmCachet || 0;
                const id = actor.id;

                container.append(`
                            <div class="col-md-4">
                                <div class="card h-100 shadow-sm">
                                    <img src="${imgUrl}"
                                         class="card-img-top"
                                         alt="${name} ${surname}"
                                         style="height: 250px; object-fit: cover;">

                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title">${name} ${surname}</h5>
                                        <p class="card-text text-muted"><i class="bi bi-globe"></i> ${nation}</p>
                                        <p class="card-text small">
                                            <strong>Film:</strong> ${filmQty} •
                                            <strong>Parcella:</strong> ${cachet.toLocaleString()}
                                        </p>

                                        <div class="mt-auto">
                                            <button class="btn btn-warning btn-sm w-100 mb-2"
                                                onclick='openEditModal(${JSON.stringify(actor).replace(/'/g, "&apos;")})'>
                                                Modifica
                                            </button>

                                            <button class="btn btn-danger btn-sm w-100"
                                                onclick="deleteActor(${id})">
                                                Elimina
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `);
            });

            console.log("✅ Rendering completato");
        }


        // ------------------------------
        //   ADD / EDIT
        // ------------------------------
        function openAddModal() {
            $("#modalTitle").text("Nuovo Attore");
            $("#actorForm")[0].reset();
            $("#actorId").val("");
        }

        function openEditModal(actor) {
            $("#modalTitle").text("Modifica Attore");
            // CORRETTO: usa camelCase (minuscolo)
            $("#actorId").val(actor.id);
            $("#actorNome").val(actor.name);
            $("#actorCognome").val(actor.surname);
            $("#actorNazionalita").val(actor.nation);
            $("#actorNumeroFilm").val(actor.filmQuantity);
            $("#actorParcellaPerFilm").val(actor.filmCachet);
            $("#actorImmagineUrl").val(actor.imgUrl);

            new bootstrap.Modal(document.getElementById("actorModal")).show();
        }

        function saveActor() {
            const id = $("#actorId").val();

            // CORRETTO: il backend si aspetta nomi in inglese con maiuscola iniziale
            const data = {
                Name: $("#actorNome").val().trim(),
                Surname: $("#actorCognome").val().trim(),
                Nation: $("#actorNazionalita").val().trim(),
                FilmQuantity: parseInt($("#actorNumeroFilm").val()) || 0,
                FilmCachet: parseFloat($("#actorParcellaPerFilm").val()) || 0,
                ImgUrl: $("#actorImmagineUrl").val().trim()
            };

            // Validazione base
            if (!data.Name || !data.Surname || !data.Nation || !data.ImgUrl) {
                alert("I campi contrassegnati da * sono obbligatori");
                return;
            }

            if (data.FilmCachet < 0) {
                alert("Il valore del cachet non può essere negativo");
                return;
            }

            if (data.FilmQuantity < 0) {
                alert("Non può aver fatto meno di 0 film");
                return;
            }

            if (id) {
                // UPDATE
                $.ajax({
                    url: `${apiBase}/${id}`,
                    method: "PUT",
                    headers: authHeaders(),
                    contentType: "application/json",
                    data: JSON.stringify(data),
                    success: () => {
                        bootstrap.Modal.getInstance(document.getElementById("actorModal")).hide();
                        loadActors();
                    },
                    error: (err) => {
                        console.error("Errore modifica:", err);
                        alert("Errore durante la modifica dell'attore");
                    }
                });

            } else {
                // INSERT
                $.ajax({
                    url: apiBase,
                    method: "POST",
                    headers: authHeaders(),
                    contentType: "application/json",
                    data: JSON.stringify(data),
                    success: () => {
                        bootstrap.Modal.getInstance(document.getElementById("actorModal")).hide();
                        loadActors();
                    },
                    error: (err) => {
                        console.error("Errore inserimento:", err);
                        alert("Errore durante l'inserimento dell'attore");
                    }
                });
            }
        }

        // ------------------------------
        //   DELETE
        // ------------------------------
        function deleteActor(id) {
            if (!confirm("Vuoi davvero eliminare questo attore?")) return;

            $.ajax({
                url: `${apiBase}/${id}`,
                method: "DELETE",
                headers: authHeaders(),
                success: () => {
                    loadActors();
                },
                error: (err) => {
                    console.error("Errore eliminazione:", err);
                    alert("Errore durante l'eliminazione dell'attore");
                }
            });
        }

        // ------------------------------
        //   SEARCH
        // ------------------------------
        $("#searchForm").on("submit", function (e) {
            e.preventDefault();
            loadActors($("#searchText").val().trim());
        });

        // ------------------------------
        //   INIT
        // ------------------------------
        $(document).ready(function () {
            const savedToken = localStorage.getItem("jwtToken");
            const savedName = localStorage.getItem("loggedUserName");

            if (savedToken) {
                jwtToken = savedToken;
                loggedUserName = savedName;
                showApp();
                loadActors();
            } else {
                showLogin();
            }
        });

    </script>

</body>
</html>